action: fire-dom-event
browser_mod:
  service: browser_mod.popup
  data:
    title: Elian
    card_mod:
      style:
        #popup header
        .:
    style: |
      --popup-max-width: 400px;
    content:
      type: vertical-stack
      cards:
        - type: entities
          card_mod:
            class: content
          entities:
            - entity: person.elian
              secondary_info: last-changed

        - type: history-graph
          card_mod:
            style: |
              ha-card > div {
                padding: 0 2em 1em 1.6em !important;
              }
          entities:
            - entity: person.elian

        - type: glance
          card_mod:
            style: |
              ha-card > div {
                padding: 1em 1.5em 0.2em 1em !important;
              }
          show_state: true
          entities:
            - entity: sensor.elians_iphone_ssid
              name: WiFi Name
              icon: mdi:wifi
              card_mod:
                style: &state |
                  state-badge {
                    color: {{ is_state(config.entity, 'home') | iif('#3182b7', '#3c3f3f') }};
                  }
            - entity: sensor.elians_iphone_battery_level
              name: Battery
              icon: mdi:battery
              card_mod:
                style: *state
            - entity: sensor.elians_iphone_geocoded_location
              name: Geo Location
              icon: mdi:map-marker-radius
              card_mod:
                style: *state

        - type: custom:mod-card
          card_mod:
            style:
              hui-horizontal-stack-card$: |
                #root {
                  justify-content: space-evenly !important;
                  padding: var(--tablet-popup-button-padding);
                }
          card:
            type: horizontal-stack
            cards:
              - type: custom:button-card
                entity: sensor.elian_work_waze
                name: Commute – Elian → Work
                icon: mdi:waze
                show_state: false
                show_label: true
                label: >-
                  [[[
                    const e = states['sensor.elian_work_waze'];      // ← גישה ישירה לסטייט
                    if (!e) return '—';
                    const v = Number(e.state);
                    const dur = Number(e.attributes?.duration);
                    const n = Number.isFinite(v) ? v : (Number.isFinite(dur) ? dur : NaN);
                    if (!Number.isFinite(n)) return '—';
                    const mins = Math.round(n);
                    return mins <= 0 ? 'Here' : `${mins} min`;      // אם אתה ממש בעבודה
                  ]]]
                triggers_update: all
                tap_action:
                  action: url
                  url_path: >-
                    [[[
                      const z = states['zone.elian_work'];
                      if (z) {
                        const { latitude: lat, longitude: lon } = z.attributes;
                        return `https://waze.com/ul?ll=${lat},${lon}&navigate=yes`;
                      }
                      return 'https://waze.com';
                    ]]]
                styles:
                  card:
                    - padding: 16px
                    - border-radius: 18px
                    - background: rgba(32,35,36,0.6)
                    - backdrop-filter: blur(6px)
                    - box-shadow: none
                  name: [font-weight: 600, font-size: 14px]
                  label:
                    [
                      font-size: 28px,
                      font-weight: 700,
                      line-height: 1.1,
                      margin-top: 4px,
                    ]
                  icon: [width: 26px]
                state:
                  - operator: "<="
                    value: 20
                    styles: { card: [background: rgba(0, 160, 100, 0.20)] } # קצר – ירקרק
                  - operator: "<="
                    value: 35
                    styles: { card: [background: rgba(200, 150, 0, 0.20)] } # בינוני – צהבהב
                  - operator: ">"
                    value: 35
                    styles: { card: [background: rgba(170, 40, 40, 0.22)] } # עמוס – אדמדם

        - type: map
          default_zoom: 16
          dark_mode: true
          entities:
            - device_tracker.elians_iphone
          card_mod:
            style:
              .: |
                #root {
                  height: 25em;
                  padding-bottom: 0 !important;
                }
                ha-icon-button {
                  color: var(--primary-color);
                  zoom: 140%;
                  margin-left: -0.2em;
                }
                ha-card {
                  border-top: 2px solid #1a1a1a;
                  border-radius: 0;
                  transition: none;
                  margin-bottom: -4px !important;
                  height: 25em !important;
                }
              ha-map$: |
                #map {
                  background-color: #191919 !important;
                }
                .leaflet-control-attribution {
                  display: none;
                }
                .leaflet-bar a {
                  background-color: rgba(115, 123, 124, 0.2) !important;
                  color: #9da0a2 !important;
                  backdrop-filter: blur(0.25em);
                  zoom: 140%;
                }
                a.leaflet-control-zoom-in {
                  border-bottom: 1px solid #181818 !important;
                }
                .leaflet-pane.leaflet-tile-pane {
                  filter: invert(0.95) grayscale(0.95) contrast(95%);
                }
